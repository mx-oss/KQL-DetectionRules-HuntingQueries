// Tentative d'exploitation de la CVE-2024-49039 - Elevation de privilèges Windows du planificateur de tâches Windows de Microsoft
// Zero-Day CVE-2024-49039 - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49039
// KQL pour detecter un attaquant authentifie qui execute initialement un AppContainer à faible privilège qui est ensuite eleve avec des privilèges grace a la vuln CVE-2024-49039
// la vulnerabilite CVE-2024-49039 dans le planificateur de tâches Windows permet à un utilisateur malveillant d'elever ses privilèges en echappant à l'AppContainer. 
// Cela signifie qu'un utilisateur avec des privilèges limites peut exploiter cette faille pour obtenir des privilèges plus eleves et acceder à des fonctions RPC privilegiees
// AppContainer est conçu pour isoler les applications et limiter leurs privilèges, mais la vulnérabilité CVE-2024-49039 dans le planificateur de tâches Windows permet à un attaquant de contourner ces restrictions et d'élever ses privilèges, compromettant ainsi la sécurité du système.
//
// Definir les endpoints vulnerables en fonction de la vulnerabilite CVE-2024-49039
let VulnerableEndpoint = 
DeviceTvmSoftwareVulnerabilities
| where CveId == "CVE-2024-49039"
| distinct DeviceName;
// Identifier les endpoints vulnerables qui ont execute un AppContainer à faible privilège
let VulnerableEPwithAppContainer =
DeviceProcessEvents
| where ProcessCommandLine contains "/appcontainer"
| where DeviceName in (VulnerableEndpoint)
| distinct DeviceName;
// Rechercher les evenements de processus sur les endpoints identifies où l'elevation de privilèges a eu lieu
DeviceProcessEvents
| where DeviceName in (VulnerableEPwithAppContainer)
| where ProcessTokenElevation == "TokenElevationTypeFull"
//
// En lien avec la vulnérabilité CVE-2024-49039, voici quelques techniques MITRE pertinentes :
// * Abuse Elevation Control Mechanism (T1548) : Les attaquants peuvent contourner les mécanismes conçus pour contrôler l'élévation des privilèges afin d'obtenir des permissions de niveau supérieur
// * Valid Accounts (T1078) : Les attaquants peuvent utiliser des comptes valides pour maintenir l'accès à un environnement
// * Scheduled Task/Job (T1053) : Les attaquants peuvent utiliser des tâches planifiées pour exécuter des commandes ou des scripts malveillants
